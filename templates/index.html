<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crop Market Price Checker</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --bg-light: linear-gradient(135deg, #f0f4ff, #e0f7fa);
      --bg-dark: linear-gradient(135deg, #141e30, #243b55);
      --text-light: #003366;
      --text-dark: #f8f9fa;
      --card-light: rgba(255, 255, 255, 0.75);
      --card-dark: rgba(40, 40, 70, 0.8);
    }

    body {
      background: var(--bg-light);
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
      transition: all 0.5s ease;
    }

    .dark-mode {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    h1 {
      font-weight: 700;
      color: var(--text-light);
      transition: color 0.5s;
    }
    .dark-mode h1 { color: var(--text-dark); }

    .card {
      border: none;
      background: var(--card-light);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: all 0.5s ease;
      animation: fadeIn 0.8s ease forwards;
    }
    .dark-mode .card {
      background: var(--card-dark);
      color: var(--text-dark);
    }

    .price-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 25px rgba(0, 0, 0, 0.2);
    }

    .btn-primary {
      background: linear-gradient(135deg, #4e54c8, #8f94fb);
      border: none;
      font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn-primary:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(78, 84, 200, 0.5);
    }

    .recent-search-item {
      background: linear-gradient(135deg, #e0eafc, #cfdef3);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 0.9rem;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      animation: fadeIn 0.5s ease;
    }
    .dark-mode .recent-search-item {
      background: linear-gradient(135deg, #2c3e50, #4ca1af);
    }

    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 999;
    }

    canvas {
      background: white;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body>

<!-- Dark Mode Toggle -->
<button class="btn btn-outline-dark theme-toggle" onclick="toggleTheme()">ðŸŒ™</button>

<div class="container py-5">
  <h1 class="text-center mb-5">Real-Time Crop Market Prices</h1>

  <div class="row">
    <!-- Form Section -->
    <div class="col-md-8">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <form id="priceForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="state" class="form-label">State</label>
                <select id="state" class="form-select" required></select>
              </div>
              <div class="col-md-6">
                <label for="district" class="form-label">District</label>
                <select id="district" class="form-select" required></select>
              </div>
              <div class="col-md-6">
                <label for="market" class="form-label">Market</label>
                <select id="market" class="form-select" required></select>
              </div>
              <div class="col-md-6">
                <label for="commodity" class="form-label">Commodity</label>
                <select id="commodity" class="form-select" required></select>
              </div>
              <div class="col-md-6">
                <label for="date" class="form-label">Date</label>
                <input type="date" class="form-control" id="date">
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-primary w-100">Get Prices</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Price Result -->
      <div id="priceResult" class="card shadow-sm price-card" style="display: none;">
        <div class="card-body">
          <h5 class="card-title" id="priceTitle"></h5>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="alert alert-success">
                <h6>Maximum Price</h6>
                <h3 id="maxPrice"></h3>
              </div>
            </div>
            <div class="col-md-6">
              <div class="alert alert-info">
                <h6>Minimum Price</h6>
                <h3 id="minPrice"></h3>
              </div>
            </div>
            <div class="col-12">
              <div class="alert alert-warning text-center">
                <h6>Predicted Price</h6>
                <h3 id="predictedPrice"></h3>
                <small class="text-muted">Based on last year's data</small>
              </div>
            </div>
            <div class="col-12">
              <div class="alert alert-secondary text-center">
                <h6>Model Accuracy</h6>
                <p id="modelAccuracy"></p>
                <small class="text-muted">Confidence of the prediction</small>
              </div>
            </div>
          </div>
          <div class="text-muted small" id="priceMeta"></div>
        </div>
      </div>

      <!-- Chart Section -->
      <div class="card shadow-sm mt-4" id="chartCard" style="display: none;">
        <div class="card-body">
          <h5 class="card-title">Price Trend (Last Year)</h5>
          <canvas id="priceChart" height="100"></canvas>
        </div>
      </div>
    </div>

    <!-- Recent Searches -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Recent Searches</h5>
          <div id="recentSearches" class="recent-searches"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- JavaScript Section -->
<script>
let metadata = {}, chart;

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const btn = document.querySelector('.theme-toggle');
  btn.textContent = document.body.classList.contains('dark-mode') ? 'ðŸŒž' : 'ðŸŒ™';
}

async function loadMetadata() {
  const response = await fetch('/api/metadata');
  const data = await response.json();
  metadata = data.structure;
  const stateSelect = document.getElementById('state');
  stateSelect.innerHTML = '<option value="">Select State</option>' +
    Object.keys(metadata).map(state => `<option value="${state}">${state}</option>`).join('');
}

function populateDropdown(parent, child, data) {
  const parentValue = parent.value;
  const nextData = data[parentValue] || {};
  child.innerHTML = '<option value="">Select</option>' +
    Object.keys(nextData).map(option => `<option value="${option}">${option}</option>`).join('');
}

function populateMarkets(state, district, marketSelect) {
  const markets = metadata[state]?.[district] || {};
  marketSelect.innerHTML = '<option value="">Select Market</option>' +
    Object.keys(markets).map(market => `<option value="${market}">${market}</option>`).join('');
}

function populateCommodities(state, district, market, commoditySelect) {
  const commodities = metadata[state]?.[district]?.[market] || [];
  commoditySelect.innerHTML = '<option value="">Select Commodity</option>' +
    commodities.map(c => `<option value="${c}">${c}</option>`).join('');
}

document.getElementById('state').addEventListener('change', () => {
  populateDropdown(document.getElementById('state'), document.getElementById('district'), metadata);
  document.getElementById('market').innerHTML = '<option value="">Select Market</option>';
  document.getElementById('commodity').innerHTML = '<option value="">Select Commodity</option>';
});

document.getElementById('district').addEventListener('change', () => {
  const state = document.getElementById('state').value;
  populateMarkets(state, document.getElementById('district').value, document.getElementById('market'));
  document.getElementById('commodity').innerHTML = '<option value="">Select Commodity</option>';
});

document.getElementById('market').addEventListener('change', () => {
  const state = document.getElementById('state').value;
  const district = document.getElementById('district').value;
  populateCommodities(state, district, document.getElementById('market').value, document.getElementById('commodity'));
});

document.getElementById('priceForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const state = document.getElementById('state').value;
  const district = document.getElementById('district').value;
  const market = document.getElementById('market').value;
  const commodity = document.getElementById('commodity').value;
  const date = document.getElementById('date').value;
  const query = new URLSearchParams({ state, district, market, commodity });
  if (date) query.append('date', date);

  fetch(`/api/price?${query}`)
    .then(res => res.json())
    .then(data => {
      if (data.error) return alert(data.error);

      document.getElementById('priceTitle').textContent = `${data.commodity} prices in ${data.market}, ${data.district}`;
      document.getElementById('maxPrice').textContent = `â‚¹${data.max_price}/${data.unit}`;
      document.getElementById('minPrice').textContent = `â‚¹${data.min_price}/${data.unit}`;
      document.getElementById('priceMeta').textContent = `Last updated: ${data.last_updated} | Source: ${data.source}`;
      document.getElementById('predictedPrice').textContent = data.predicted_price ? `â‚¹${data.predicted_price}/${data.unit}` : 'N/A';
      document.getElementById('modelAccuracy').textContent = data.model_accuracy ? `Accuracy: ${data.model_accuracy}%` : 'Accuracy: N/A';

      document.getElementById('priceResult').style.display = 'block';
      addRecentSearch(data);
      loadTrendChart(query);
    })
    .catch(err => {
      console.error('Error:', err);
      alert('Failed to fetch price data');
    });
});

function addRecentSearch(data) {
  const recentSearches = document.getElementById('recentSearches');
  const item = document.createElement('div');
  item.className = 'recent-search-item';
  item.innerHTML = `
    <strong>${data.commodity}</strong><br>
    <small>${data.market}, ${data.district}</small><br>
    <span class="text-success fw-bold">â‚¹${data.max_price}</span> - 
    <span class="text-info fw-bold">â‚¹${data.min_price}</span>/${data.unit}`;
  recentSearches.prepend(item);
  if (recentSearches.children.length > 10) recentSearches.removeChild(recentSearches.lastChild);
}

function renderTrendChart(labels, prices, predicted, unit) {
  const ctx = document.getElementById('priceChart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Average Price',
          data: prices,
          borderColor: '#007bff',
          backgroundColor: 'rgba(0,123,255,0.1)',
          tension: 0.3,
          pointRadius: 2
        },
        {
          label: 'Predicted Price',
          data: prices.map((_, i) => i === prices.length - 1 ? predicted : null),
          borderColor: '#28a745',
          borderDash: [5, 5],
          pointRadius: 5,
          pointBackgroundColor: '#28a745',
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: { title: { display: true, text: `Price (${unit})` } },
        x: { ticks: { maxRotation: 45, minRotation: 45 } }
      },
      plugins: { legend: { position: 'top' } }
    }
  });
  document.getElementById('chartCard').style.display = 'block';
}

function loadTrendChart(query) {
  fetch(`/api/trend?${query}`)
    .then(res => res.json())
    .then(data => {
      if (data.error) return alert(data.error);
      const { trend, predicted, unit } = data;
      const labels = [...trend.dates].reverse();
      const prices = [...trend.prices].reverse();
      const predictedValue = predicted?.[0] ?? null;
      renderTrendChart(labels, prices, predictedValue, unit);
    })
    .catch(err => {
      console.error('Error:', err);
      alert('Failed to fetch price trend data');
    });
}

window.onload = loadMetadata;
</script>

</body>
</html>
